# EncryptionServer

## Getting started

1. Setup:

- create `.env` file in project root directory [encryption_server](./encryption_server) with environmental variables which will be used in application,
  example [.env.example](./encryption_server/.env.example) file has been created
- install required dependencies from [package.json](./encryption_server/package.json) using `npm` or `yarn`
- `yarn` was used by myself in development process

2. Available scripts:

- `start` - starts application
- `dev` - starts application in dev environment using Nodemon

Project can be run with package manager of your choice (`npm` or `yarn`)

- Mocked users with details:

```json
[
  {
    "id": 0,
    "name": "John Doe",
    "username": "john",
    "email": "john@example.com",
    "password": "john123",
  },
  {
    "id": 1,
    "name": "Jane Doe",
    "username": "jane",
    "email": "jane@example.com",
    "password": "jane123",
  },
];
```

- Authorization in application has been implemented using JWT tokens sent in HTTP `Authorization` header using HTTP Bearer authentication scheme:

```
Authorization: Bearer {JWT_TOKEN}
```

Project was tested with `Node.js v14.17.6` (`npm v6.14.15`) and `yarn v1.22.5`

### Available endpoints

- Unauthorized `POST /api/sign-in`

- Authorized `POST /api/generate-key-pair`

- Authorized `POST /api/encrypt`

## Testing file encryption made by EncryptionServer

To test encryption of sample PDF file [sample.pdf](http://www.africau.edu/images/default/sample.pdf) used in encryption process made by `EncryptionServer`
prepare your private key generated by server, base64-encoded encrypted pdf file content, base64-encoded encrypted encryption key and hex-encoded initialization vector
and save all of them in separate files.

`openssl` package installed on system is required to decrypt file.

Glossary:

- ivHex - initialization vector used in AES encryption - random 16 bytes, randomly generated in each call of encryption made by server, returned by server as hex-encoded
- keyBase64 - random 32 bytes key used in AES encryption additionally encrypted by RSA public key, randomly generated in each call of encryption made by server,
  returned by server as base64-encoded
- fileBase64 - base64-encoded encrypted pdf file's content
- RSA private key passphrase - passphrase for RSA private key encryption, defined in `.env` file
- RSA private encrypted key - key used in process of pdf file decryption

Files naming conventions used in this instruction:

- {aes_key.base64} - file holding base64-encoded encrypted AES key returned from `/api/encrypt` endpoint as `keyBase64`
- {aes_iv.hex} - file holding hex-encoded AES initialization vector returned from `/api/encrypt` endpoint as `ivHex`
- {file.base64} - file holding base64-encoded AES encrypted pdf file content returned from `/api/encrypt` endpoint as `fileBase64`
- {private_key.pem} - file holding RSA private key in PEM format returned from `/api/generate-key-pair` endpoint as `privKey`

Steps (replace all files enclosed in {} with your files names):

1. Decode base64-encoded AES key and save it in separate file:

```
cat {aes_key.base64} | base64 -d > {aes_key.bin}
```

2. Replace all `\n` newline characters in {private_key.pem} by "real" newlines:

```
sed -i -e 's/\\n/\n/g' {private_key.pem}
```

3. Decrypt encrypted AES key with your private RSA key:

```
openssl rsautl -decrypt -in {aes_key.bin} -out {aes_key.dec.bin} -inkey {private_key.pem} -keyform PEM -oaep -passin pass:{rsa_private_key_encryption_password}
```

4. Decrypt pdf file using decrypted AES key:

```
openssl aes-256-ctr -d -in file.base64 -out sample.pdf -base64 -A -K `cat {aes_key.dec.bin} | od -A n -v -t x1 | tr -d ' \n'` -iv `cat {aes_iv.hex}`

```
